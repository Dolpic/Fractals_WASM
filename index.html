<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Fractals</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="index.css">
  </head>

  <body onload="init()">
    <h1>Fractals</h1>
    <p class="subtitle">Multi-threaded Fractal computation</p>
    <hr>
    <section>
      <aside>
        <div id="controlPanel"></div>
        <details>
          <summary>Advanced options</summary>
          <div id="advancedControlPanel"></div>
        </details>
      </aside>
      <div id="canvasContainer">
        <canvas id=canvas></canvas>
      </div>
    </section>
    <hr>
    <p>
      This set is generated by the complex equation Z=Z<sup>2</sup>+C. 
      For each point C of the complex plane, starting with Z=0, the formula is computed multiple times. 
      The set is made of all the point for which the norm does not tend toward infinity.
    </p>
    <p>
      The computation is multithreaded using JavaScript workers, calling a WebAssembly executable made using Rust. 
    </p>

    
    <script src="Fractal.js"></script>
    <script>
      fractal = undefined
      sliders = []

      function init(){
        addInput("imageWidth",  "Width",                 800)
        addInput("imageHeight", "Height",                800)
        addInput("imageZoom",   "Zoom",                  200, true,  200)
        addInput("imageX",      "X position",            0,   true)
        addInput("imageY",      "Y position",            0,   true)
        addInput("nb_workers",  "Number of threads",     15,  false, 0, true)
        addInput("chunkSize",   "Chunk size per thread", 100, false, 0, true)
        addInput("iterations",  "Iterations",            200, false, 0, true)

        addColor("colorIn",    "Color inside the set",  "#3fac84", true)
        addColor("colorOut",   "Color outside the set", "#173c54", true)
        addColor("colorHigh",  "Color highlight",       "#b4f9de", true)
        
        fractal = new Fractal(
          document.getElementById("canvas"),
          getInputVal("nb_workers")
        )
        updateColors()
        update()
      }

      function getInputVal(id){
        let obj = document.getElementById(id+"_text")
        if(obj.value != ""){
          return parseFloat(obj.value)
        }else{
          return parseFloat(obj.placeholder)
        }
      }

      function addInput(id, label_str, placeholder, has_slider=false, start_value=0, isAdvanced=false){
        let container = document.createElement("div")
        container.className = "controller"

        let label = document.createElement("label")
        label.innerHTML = label_str

        let input_text = document.createElement("input")
        input_text.id          = id+"_text"
        input_text.placeholder = placeholder
        input_text.type        = "text"
        input_text.addEventListener("input", update)

        container.appendChild(label)
        container.appendChild(input_text)
        if(has_slider) {
          let input_range   = document.createElement("input")
          input_range.id    = id+"_range"
          input_range.type  = "range"
          input_range.min   = (start_value+1)/3
          input_range.max   = (start_value+1)*3
          input_range.step  = 0.001

          sliders.push(input_range)
          container.appendChild(input_range)
          input_text.addEventListener( "input", () => input_range.value = input_text.value)
          input_range.addEventListener("input", () => {input_text.value  = input_range.value; update()})
          input_range.addEventListener("change", updateSliders)
          input_range.value = input_text.placeholder
        }
        document.getElementById(isAdvanced?"advancedControlPanel":"controlPanel").appendChild(container)
      }

      function updateSliders(){
        sliders.forEach(s => {
          if(s.id == "imageZoom_range"){
            s.min  = s.value/4
            s.max  = s.value*4
            s.step = 1
          }else{
            s.min  = parseFloat(s.value) - 200/getInputVal("imageZoom")
            s.max  = parseFloat(s.value) + 200/getInputVal("imageZoom")
            s.step = 1/(10*getInputVal("imageZoom"))
          }
        });
      }

      function update(){
        fractal.set_parameters(
          [getInputVal("imageWidth"), getInputVal("imageHeight")],
          [getInputVal("imageX"),     getInputVal("imageY")],
          [getInputVal("imageZoom")],
          getInputVal("iterations"),
          getInputVal("chunkSize")
        )
        fractal.start_rendering()
      }

      function addColor(id, label_str, default_value, isAdvanced=false){
        let container =  document.createElement("div")
        container.className = "controller"

        let color = document.createElement("input")
        color.type = "color"
        color.id = id
        color.value = default_value

        let label = document.createElement("label")
        label.innerHTML = label_str

        container.appendChild(label)
        container.appendChild(color)
        document.getElementById(isAdvanced?"advancedControlPanel":"controlPanel").appendChild(container)
        color.addEventListener("change", updateColors)
      }

      function updateColors(){
        fractal.set_colors(
          document.getElementById("colorIn").value,
          document.getElementById("colorOut").value,
          document.getElementById("colorHigh").value
        )
        fractal.start_rendering()
      }
    </script>
  </body>
</html>
